#!/bin/bash
#
# /usr/local/bin/fix-rb-bin Patches system RubyGems-generated executables to
# make them work with even within an RVM environment.

set -e

while test -n "$1"; do
    echo 1>&2 -n "$1... "
    cat "$1" > /dev/null
    if ! head -n 3 -- "$1" | grep -q -- '^# This file was generated by RubyGems.$'; then
        echo 1>&2 "not a RubyGems-generated executable"
    elif grep -q -- "ENV.delete('GEM_PATH')" "$1"; then
        echo 1>&2 "already patched; not modified"
    else
        gsed -i -- "8iENV.delete('GEM_PATH')" "$1"
        echo 1>&2 "successfully patched"
    fi
    shift
done
